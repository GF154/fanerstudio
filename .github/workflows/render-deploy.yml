name: ğŸš€ Auto-Deploy to Render
run-name: Deploying Faner Studio to Render

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  validate:
    name: ğŸ” Pre-deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Validate requirements.txt
        run: |
          if [ -f requirements.txt ]; then
            echo "âœ… requirements.txt found"
            echo "ğŸ“‹ Dependencies:"
            cat requirements.txt
            
            # Check for security vulnerabilities
            pip install safety
            safety check -r requirements.txt --continue-on-error || echo "âš ï¸ Security warnings found"
          else
            echo "âŒ requirements.txt not found"
            exit 1
          fi
      
      - name: ğŸ”§ Check main.py syntax
        run: |
          if [ -f main.py ]; then
            echo "âœ… main.py found"
            python -m py_compile main.py
            echo "âœ… Syntax validation passed"
          else
            echo "âŒ main.py not found"
            exit 1
          fi
      
      - name: ğŸ“Š Validation Summary
        if: success()
        run: |
          echo "âœ… All validation checks passed!"
          echo "ğŸš€ Ready for deployment"

  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name != 'pull_request'
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Install Render CLI
        run: |
          echo "ğŸ“¥ Downloading Render CLI..."
          curl -fsSL https://github.com/render-oss/cli/releases/download/v1.1.0/cli_1.1.0_linux_amd64.zip -o render.zip
          
          echo "ğŸ“¦ Extracting..."
          unzip -q render.zip
          
          echo "âš™ï¸ Installing..."
          sudo mv cli_v1.1.0 /usr/local/bin/render
          sudo chmod +x /usr/local/bin/render
          
          echo "âœ… Render CLI installed successfully"
          render --version
      
      - name: ğŸš€ Trigger Render Deploy
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          CI: true
        run: |
          # Validate secrets
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "âŒ Error: RENDER_API_KEY or RENDER_SERVICE_ID not set"
            echo ""
            echo "ğŸ“ To fix this:"
            echo "  1. Go to: https://github.com/$GITHUB_REPOSITORY/settings/secrets/actions"
            echo "  2. Add RENDER_API_KEY (from https://dashboard.render.com/u/settings)"
            echo "  3. Add RENDER_SERVICE_ID (from your service URL: srv-xxxxx)"
            exit 1
          fi
          
          echo "ğŸ¯ Starting deployment..."
          echo "ğŸ“¦ Repository: $GITHUB_REPOSITORY"
          echo "ğŸ”€ Branch: $GITHUB_REF_NAME"
          echo "ğŸ“ Commit: $GITHUB_SHA"
          echo "ğŸ‘¤ Author: $GITHUB_ACTOR"
          echo ""
          
          # Trigger deployment
          echo "ğŸš€ Deploying to Render service: $RENDER_SERVICE_ID"
          if render deploys create $RENDER_SERVICE_ID --output json --confirm; then
            echo ""
            echo "âœ… Deployment triggered successfully!"
          else
            echo ""
            echo "âŒ Deployment command failed"
            echo "ğŸ’¡ Possible reasons:"
            echo "  - Invalid API key or Service ID"
            echo "  - Network issues"
            echo "  - Render service down"
            exit 1
          fi
      
      - name: â³ Wait for deployment
        run: |
          echo "â³ Waiting for deployment to complete..."
          echo "This may take 2-5 minutes..."
          sleep 30
          echo "âœ… Initial deployment phase completed"
      
      - name: ğŸ¥ Health Check
        continue-on-error: true
        env:
          RENDER_SERVICE_URL: ${{ secrets.RENDER_SERVICE_URL }}
        run: |
          echo "ğŸ¥ Performing health check..."
          
          # Try to get the service URL (if available via environment)
          if [ ! -z "$RENDER_SERVICE_URL" ]; then
            SERVICE_URL="$RENDER_SERVICE_URL"
            echo "ğŸŒ Testing: ${SERVICE_URL}/health"
            
            # Wait a bit more for service to be ready
            sleep 20
            
            # Attempt health check
            for i in {1..5}; do
              echo "Attempt $i/5..."
              if curl -f -s "${SERVICE_URL}/health" > /dev/null; then
                echo "âœ… Health check passed!"
                curl -s "${SERVICE_URL}/health" | jq '.' || true
                break
              else
                echo "â³ Service not ready yet, waiting..."
                sleep 10
              fi
            done
          else
            echo "â„¹ï¸ RENDER_SERVICE_URL not configured, skipping automated health check"
          fi
      
      - name: ğŸ“Š Deployment Success
        if: success()
        env:
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ Deployment Completed Successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“ Render Dashboard:"
          echo "   https://dashboard.render.com"
          echo ""
          echo "ğŸ”— Service Details:"
          echo "   https://dashboard.render.com/web/$RENDER_SERVICE_ID"
          echo ""
          echo "ğŸ“ Deployment Info:"
          echo "   Repository: $GITHUB_REPOSITORY"
          echo "   Branch: $GITHUB_REF_NAME"
          echo "   Commit: $GITHUB_SHA"
          echo "   Author: $GITHUB_ACTOR"
          echo "   Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ”” Notify on Failure
        if: failure()
        env:
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ Deployment Failed!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Troubleshooting steps:"
          echo "  1. Check the logs above for specific errors"
          echo "  2. Verify secrets are correctly set"
          echo "  3. Check Render dashboard for service status"
          echo "  4. Review recent code changes"
          echo ""
          echo "ğŸ“š Helpful links:"
          echo "   GitHub Actions: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
          echo "   Render Dashboard: https://dashboard.render.com"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

